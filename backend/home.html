<!DOCTYPE html>
<html lang="en">
<head>
<title>IO Game</title>
<script type="text/javascript">
window.onload = function () {
    var conn;
    var canvas = document.getElementById('gameCanvas');
    var ctx = canvas.getContext('2d');
    var gameInfo;
    
    // 設置畫布大小為視窗大小
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    
    // 監聽視窗大小變化
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    // 繪製玩家
    function drawPlayer(player) {
        player.Health = Math.max(player.Health, 0);
        ctx.fillStyle = player.Health > 50 ? 'green' : 'red';

        ctx.fillRect(player.X - player.Width / 2, player.Y - player.Height / 2, player.Width, player.Height);
        
        // 繪製血量條
        ctx.fillStyle = 'black';
        ctx.fillRect(player.X - player.Width / 2, player.Y - player.Height / 2 - 10, player.Width, 5);
        ctx.fillStyle = 'red';
        ctx.fillRect(player.X - player.Width / 2, player.Y - player.Height / 2 - 10, (player.Health / 100) * player.Width, 5);
        
        // 繪製玩家ID
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.fillText('Player ' + player.ID, player.X - player.Width / 2, player.Y - player.Height / 2 - 15);
    }
    
    // 繪製武器
    function drawWeapon(weapon) {
        ctx.fillStyle = 'yellow';
        ctx.fillRect(weapon.X - weapon.Width / 2, weapon.Y - weapon.Height / 2, weapon.Width, weapon.Height);
    }
    
    // 繪製遊戲畫面
    function drawGame(gameInfo) {
        // 清空畫布
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 繪製所有玩家和他們的武器
        gameInfo.Players.forEach(function(player) {
            drawPlayer(player);
            player.Weapons.forEach(function(weapon) {
                drawWeapon(weapon);
            });
        });
    }

    // 處理接收到的消息
    function handleMessage(evt) {
        try {
            gameInfo = JSON.parse(evt.data);
            drawGame(gameInfo);
        } catch (e) {
            console.error('Error parsing game info:', e);
        }
    }

    // 建立 WebSocket 連接
    if (window["WebSocket"]) {
        conn = new WebSocket("ws://" + document.location.host + "/ws");
        conn.onclose = function (evt) {
            ctx.fillStyle = 'red';
            ctx.font = '30px Arial';
            ctx.fillText('Connection closed', canvas.width/2 - 100, canvas.height/2);
        };
        conn.onmessage = handleMessage;
    } else {
        ctx.fillStyle = 'red';
        ctx.font = '30px Arial';
        ctx.fillText('Your browser does not support WebSockets', canvas.width/2 - 200, canvas.height/2);
    }

    // Add event listener for mouse movement
    canvas.addEventListener('mousemove', function(event) {
        // Get mouse position relative to the canvas
        var rect = canvas.getBoundingClientRect();
        var mouseX = event.clientX - rect.left;
        var mouseY = event.clientY - rect.top;

        // Calculate angle between player and mouse position
        gameInfo.Players.forEach(function(player) {
            var deltaX = mouseX - player.X;
            var deltaY = mouseY - player.Y;
            var angle = Math.atan2(deltaY, deltaX);

            // Send the new angle to the server
            if (conn && conn.readyState === WebSocket.OPEN) {
                var message = JSON.stringify({ direction: angle });
                console.log("send message", message);
                conn.send(message);
            }
        });
    });
};
</script>
<style type="text/css">
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

#gameCanvas {
    display: block;
    background: #333;
}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
</body>
</html>
